# MQTT-GPIO

<img align="left"  src="img_1.png">



https://www.cdebyte.com/products/NT1-B

![](gpio1.svg)

## Первоначальная настройка модуля
<details><summary>Настройка модуля</summary>
  
Первоначально модуль сидит на статическом адресе 192.168.3.3
настраиваем сеть компа и заходим

![](nt1b_mqtt_settings.png)

Настоятельно рекомендую настроить именно автоматическое получение адреса по DHCP.

Устанавливаем там где 0, нужный нам порядковый номер модуля и нажимаем submit,
пароль для сохранения 123456 после чего перезагружаем по питанию.

В сети его потом можно будет найти по доменному имени MAC адресу:
![](mac-domain.png)

</details>


## Команды

Все команды 4-х байтовые: номер_подмодуля/команда/порт/значение

Для преобразования в удобочитаемые команды применяется сервис mqtt_gpio

### MQTT -> GPIO

| команда (что поступает из UART на STM32) | описание                                 | Mqtt                       |
|------------------------------------------|------------------------------------------|----------------------------|
| 00 **00** (00..31) 00                    | выключить порт (00..31)                  | `GPIO/1/0/SET/25/0`        |
| 00 **00** (00..31) (1..255)              | включить порт (00..31)                   | `GPIO/1/0/SET/25/1`        |
| 00 **00** (00..31) (0..255)              | установить PWM в процентах               | `GPIO/1/0/SET/25/124`      |
| 00 **03** byte0 byte1                    | команда DALI                             |                            |
|                                          | установить значение светильника 25 в 124 | `GPIO/1/DALI/SET/25/124`   |
|                                          | установить значение группы 12 в 0        | `GPIO/1/DALI/SET_GRP/12/0` |
|                                          | команда RAW DALI                         | `GPIO/1/DALI/RAW`          |

Внимание! Если мы обращаемся к нулевому (единственному) подмодулю, то можно подмодуль не указывать:  
вместо `GPIO/1/0/SET/25/1` пишем `GPIO/1/SET/25/1`

> 00 - подмодуль  
> 00 - команда SET  
> (00..31) - номер порта  
> 00 - значение  

<details><summary>Подробнее</summary>

![](mqtt_messages_receive.svg)

</details>

### GPIO -> MQTT

#### PUSH

| команда (что поступает из STM32 на UART) | событие      | описание                           |
|------------------------------------------|--------------|------------------------------------|
| 00 **_00_** 25 00                        | PUSH         | нажали кнопку на порту 25 модуля 2 |

> 00 - подмодуль  
> 00 - команда PUSH  
> 25 - номер порта  
> 00 - значение (в данном случае не используется)  

`GPIO/2/0/PUSH/25`

<details><summary>Подробнее</summary>

![](mqtt_messages_event.svg)

</details>

#### DALI RAW

Ответ, поступивший по шине DALI


| команда (что поступает из STM32 на UART) | событие      | описание                           |
|------------------------------------------|--------------|------------------------------------|
| 00 **_03_** byte1                        | DALI/RAW_RET | ответ от шины DALI                 |

`GPIO/2/DALI/RAW_RET/`

## Модульная система

Модули могут работать как одиночно, в этом случае они подключаются по Ethernet, так и связываться по шине CAN, если в данном месте модулей нужно более одного.

![](can_modules.svg)

## Распайка компонентов портов

[см.](gpio_pic/readme.md)
